<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Universal Music Downloader</title>
    <link rel="icon" type="image/png" href="static/fevicon2.png" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Modern Light theme (default) */
        --bg-primary: #fafafa;
        --bg-secondary: #f5f5f5;
        --bg-card: #ffffff;
        --text-primary: #2d2d2d;
        --text-secondary: #6b7280;
        --text-tertiary: #9ca3af;
        --accent-color: #10b981;
        --accent-secondary: #059669;
        --border-color: #e5e7eb;
        --shadow-color: rgba(16, 185, 129, 0.15);
        --success-color: #10b981;
        --error-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #8b5cf6;
        --download-color: #a855f7;
        --gradient-primary: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);
        --gradient-secondary: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --status-success-bg: rgba(16, 185, 129, 0.1);
        --status-success-border: rgba(16, 185, 129, 0.3);
        --status-error-bg: rgba(239, 68, 68, 0.1);
        --status-error-border: rgba(239, 68, 68, 0.3);
        --status-warning-bg: rgba(245, 158, 11, 0.1);
        --status-warning-border: rgba(245, 158, 11, 0.3);
        --status-info-bg: rgba(139, 92, 246, 0.1);
        --status-info-border: rgba(139, 92, 246, 0.3);
        --status-loading-bg: rgba(128, 128, 128, 0.03);
        --status-loading-border: rgba(128, 128, 128, 0.15);
      }

      /* Modern Dark theme */
      body:not(.light-theme) {
        --bg-primary: #0f0f0f;
        --bg-secondary: #1a1a1a;
        --bg-card: #1f1f1f;
        --text-primary: #f0f0f0;
        --text-secondary: #d1d5db;
        --text-tertiary: #9ca3af;
        --accent-color: #34d399;
        --accent-secondary: #10b981;
        --border-color: #374151;
        --shadow-color: rgba(52, 211, 153, 0.2);
        --success-color: #34d399;
        --error-color: #f87171;
        --warning-color: #fbbf24;
        --info-color: #a78bfa;
        --download-color: #c084fc;
        --gradient-primary: linear-gradient(135deg, #c084fc 0%, #7c3aed 100%);
        --gradient-secondary: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        --status-success-bg: rgba(52, 211, 153, 0.15);
        --status-success-border: rgba(52, 211, 153, 0.4);
        --status-error-bg: rgba(248, 113, 113, 0.15);
        --status-error-border: rgba(248, 113, 113, 0.4);
        --status-warning-bg: rgba(251, 191, 36, 0.15);
        --status-warning-border: rgba(251, 191, 36, 0.4);
        --status-info-bg: rgba(167, 139, 250, 0.15);
        --status-info-border: rgba(167, 139, 250, 0.4);
        --status-loading-bg: rgba(128, 128, 128, 0.05);
        --status-loading-border: rgba(128, 128, 128, 0.2);
      }

      body.light-theme {
        --bg-primary: #fafafa;
        --bg-secondary: #f5f5f5;
        --bg-card: #ffffff;
        --text-primary: #2d2d2d;
        --text-secondary: #6b7280;
        --text-tertiary: #9ca3af;
        --accent-color: #10b981;
        --accent-secondary: #059669;
        --border-color: #e5e7eb;
        --shadow-color: rgba(16, 185, 129, 0.15);
        --success-color: #10b981;
        --error-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #8b5cf6;
        --download-color: #a855f7;
        --gradient-primary: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);
        --gradient-secondary: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --status-success-bg: rgba(16, 185, 129, 0.1);
        --status-success-border: rgba(16, 185, 129, 0.3);
        --status-error-bg: rgba(239, 68, 68, 0.1);
        --status-error-border: rgba(239, 68, 68, 0.3);
        --status-warning-bg: rgba(245, 158, 11, 0.1);
        --status-warning-border: rgba(245, 158, 11, 0.3);
        --status-info-bg: rgba(139, 92, 246, 0.1);
        --status-info-border: rgba(139, 92, 246, 0.3);
        --status-loading-bg: rgba(128, 128, 128, 0.03);
        --status-loading-border: rgba(128, 128, 128, 0.15);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          system-ui, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
        transition: all 0.3s ease;
        line-height: 1.6;
        font-weight: 400;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
      }

      /* Enhanced visual hierarchy */
      .header {
        text-align: center;
        margin-bottom: 60px;
        padding: 40px 20px;
      }

      .header h1 {
        font-family: "Inter", sans-serif;
        font-size: 3.2em;
        font-weight: 800;
        margin-bottom: 15px;
        color: var(--text-primary);
        letter-spacing: -0.02em;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .header p {
        color: var(--text-secondary);
        font-size: 1.1em;
        font-weight: 400;
        opacity: 0.8;
      }

      .search-box {
        padding: 30px 20px;
        margin-bottom: 50px;
      }

      /* Download Manager */
      .download-manager {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 350px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 70vh;
        overflow-y: auto;
        display: none;
      }

      .download-manager.show {
        display: block;
      }

      .download-manager-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--accent-color);
        color: white;
        border-radius: 13px 13px 0 0;
      }

      .download-manager-header h3 {
        margin: 0;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .download-manager-controls {
        display: flex;
        gap: 8px;
      }

      .download-manager-controls button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        border-radius: 5px;
        padding: 5px 8px;
        cursor: pointer;
        font-size: 0.8em;
        transition: all 0.2s;
      }

      .download-manager-controls button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .download-list {
        max-height: 50vh;
        overflow-y: auto;
      }

      .download-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.3s;
      }

      .download-item:last-child {
        border-bottom: none;
      }

      .download-item.downloading {
        background: rgba(0, 184, 148, 0.1);
      }

      .download-item.queued {
        background: rgba(108, 92, 231, 0.05);
        border-left: 3px solid var(--download-color);
      }

      .download-item.complete {
        background: rgba(0, 184, 148, 0.05);
      }

      .download-item.error {
        background: rgba(231, 76, 60, 0.05);
      }

      .download-item.cancelled {
        background: rgba(149, 165, 166, 0.05);
      }

      .download-title {
        font-weight: bold;
        font-size: 0.9em;
        margin-bottom: 5px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        color: var(--text-primary);
      }

      .download-progress {
        margin-bottom: 8px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent-color);
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      .progress-fill.complete {
        background: var(--success-color);
      }

      .progress-fill.error {
        background: var(--error-color);
      }

      .progress-fill.queued {
        background: var(--download-color);
        width: 100% !important;
        opacity: 0.3;
      }

      .download-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8em;
        color: var(--text-secondary);
      }

      .download-actions {
        display: flex;
        gap: 5px;
      }

      .download-actions button {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 3px;
        padding: 2px 6px;
        cursor: pointer;
        font-size: 0.7em;
        transition: all 0.2s;
      }

      .download-actions button:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
      }

      .download-actions button.cancel {
        border-color: var(--error-color);
        color: var(--error-color);
      }

      .download-actions button.cancel:hover {
        background: var(--error-color);
        color: white;
      }

      .download-manager-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        box-shadow: 0 4px 12px var(--shadow-color);
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        font-size: 1.2em;
      }

      .download-manager-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px var(--shadow-color);
      }

      .download-manager-toggle .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--error-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7em;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .header {
        text-align: center;
        padding: 30px 0;
        margin-bottom: 30px;
        position: relative;
      }

      .theme-toggle {
        position: absolute;
        top: 30px;
        right: 20px;
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: 25px;
        padding: 8px 15px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
        color: var(--text-secondary);
      }

      .theme-toggle:hover {
        background: var(--accent-color);
        color: var(--bg-primary);
        border-color: var(--accent-color);
      }

      .header h1 {
        font-size: 3em;
        color: var(--accent-color);
        font-weight: 700;
        margin-bottom: 10px;
        text-align: center;
      }

      .header h1 a {
        display: inline-flex !important;
        align-items: center;
        width: auto;
        transition: all 0.3s ease;
      }

      .header p {
        color: var(--text-secondary);
        font-size: 1.2em;
        text-align: center;
        margin-bottom: 0;
      }

      .search-box {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }

      .search-type-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
      }

      .type-btn {
        padding: 10px 25px;
        font-size: 1em;
        font-weight: bold;
        background: var(--bg-card);
        color: var(--text-secondary);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .type-btn:hover {
        background: var(--accent-color);
        color: var(--bg-primary);
      }

      .type-btn.active {
        background: linear-gradient(
          135deg,
          var(--accent-color) 0%,
          var(--accent-secondary) 100%
        );
        color: var(--bg-primary);
        border-color: var(--accent-color);
      }

      .search-input-group {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .query-hint {
        text-align: center;
        font-size: 0.9em;
        color: var(--text-tertiary);
        margin-top: 10px;
      }

      .query-hint.url-detected {
        color: var(--accent-color);
      }

      /* Advanced Download Options */
      .advanced-options {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid var(--border-color);
        display: none;
      }

      .advanced-options.show {
        display: block;
      }

      .advanced-toggle {
        background: none;
        border: none;
        color: var(--accent-color);
        cursor: pointer;
        font-size: 0.9em;
        padding: 5px 10px;
        text-decoration: underline;
        margin-top: 10px;
      }

      .advanced-toggle:hover {
        color: var(--accent-secondary);
      }

      /* Options Tabs */
      .options-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .tab-btn {
        flex: 1;
        padding: 10px 20px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .tab-btn:hover {
        color: var(--text-primary);
        background: var(--bg-primary);
      }

      .tab-btn.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
      }

      .options-tab-content {
        display: none;
      }

      .options-tab-content.active {
        display: block;
      }

      .option-group {
        margin-bottom: 15px;
      }

      .option-group label {
        display: block;
        margin-bottom: 5px;
        color: var(--text-secondary);
        font-size: 0.9em;
        font-weight: bold;
      }

      .option-group select,
      .option-group input[type="text"] {
        width: 100%;
        padding: 8px 12px;
        border-radius: 5px;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.9em;
      }

      .option-group input[type="checkbox"] {
        margin-right: 8px;
      }

      .option-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }

      #searchInput {
        flex: 1;
        padding: 18px 25px;
        font-size: 1.2em;
        border: 2px solid var(--border-color);
        border-radius: 15px;
        background: var(--bg-primary);
        color: var(--text-primary);
        outline: none;
        transition: all 0.3s ease;
      }

      #searchInput:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 4px var(--shadow-color);
        transform: translateY(-2px);
      }

      /* Search Suggestions Dropdown */
      .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 80px;
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 15px 15px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .search-suggestions.show {
        display: block;
      }

      .suggestion-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-item:hover,
      .suggestion-item.highlighted {
        background: var(--accent-color);
        color: var(--bg-primary);
      }

      .suggestion-item .suggestion-icon {
        width: 16px;
        height: 16px;
        opacity: 0.7;
      }

      .suggestion-item .suggestion-text {
        flex: 1;
        font-size: 0.95em;
      }

      #searchBtn {
        padding: 18px 45px;
        font-size: 1.2em;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          var(--accent-color) 0%,
          var(--accent-secondary) 100%
        );
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 140px;
      }

      #searchBtn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px var(--shadow-color);
      }

      #searchBtn:active {
        transform: translateY(-1px);
      }

      #searchBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        text-align: center;
        padding: 20px 25px;
        border-radius: 15px;
        margin: 20px auto;
        max-width: 600px;
        display: none;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
        border: 2px solid transparent;
        font-weight: 500;
        font-size: 1.1em;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(10px);
        opacity: 0;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .status::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.5s ease;
      }

      .status.show {
        display: block;
        transform: translateY(0);
        opacity: 1;
      }

      .status.searching {
        background: var(--status-loading-bg);
        border-color: var(--status-loading-border);
        color: var(--download-color);
        display: block;
        transform: translateY(0);
        opacity: 1;
      }

      .status.searching::before {
        left: 100%;
      }

      .status.complete {
        background: var(--status-success-bg);
        border-color: var(--status-success-border);
        color: var(--success-color);
        display: block;
        transform: translateY(0);
        opacity: 1;
      }

      .status.error {
        background: var(--status-error-bg);
        border-color: var(--status-error-border);
        color: var(--error-color);
        display: block;
        transform: translateY(0);
        opacity: 1;
      }

      .status.warning {
        background: var(--status-warning-bg);
        border-color: var(--status-warning-border);
        color: var(--warning-color);
        display: block;
        transform: translateY(0);
        opacity: 1;
      }

      .status.info {
        background: var(--status-info-bg);
        border-color: var(--status-info-border);
        color: var(--info-color);
        display: block;
        transform: translateY(0);
        opacity: 1;
      }

      /* Enhanced loading spinner */
      .status .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: currentColor;
        animation: spin 1s linear infinite;
        margin-right: 10px;
        vertical-align: middle;
      }

      /* Status icons */
      .status-icon {
        display: inline-block;
        margin-right: 10px;
        vertical-align: middle;
        animation: statusIconPulse 2s ease-in-out infinite;
      }

      @keyframes statusIconPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Success animation */
      .status.complete .status-icon {
        animation: successBounce 0.6s ease-out;
      }

      @keyframes successBounce {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Error shake animation */
      .status.error {
        animation: errorShake 0.5s ease-in-out;
      }

      @keyframes errorShake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      .results-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .source-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        display: none;
      }

      .source-section.active {
        display: block;
      }

      .source-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .source-navigation {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        display: none;
        align-items: center;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .source-navigation.active {
        display: flex;
      }

      .source-nav-btn {
        padding: 12px 25px;
        font-size: 1em;
        font-weight: bold;
        background: var(--bg-card);
        color: var(--text-secondary);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .source-nav-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      .source-nav-btn.active {
        background: var(--accent-color);
        color: var(--bg-primary);
        border-color: var(--accent-color);
      }

      .source-nav-btn .count {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.85em;
        margin-left: 8px;
      }

      .source-nav-btn.active .count {
        background: rgba(0, 0, 0, 0.2);
      }

      .source-header h2 {
        font-size: 1.5em;
        color: var(--accent-color);
      }

      .source-header .count {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
      }

      .songs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
      }

      .song-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        border-radius: 10px;
        padding: 15px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s;
        cursor: pointer;
      }

      .song-card:hover {
        transform: translateY(-5px);
        border-color: var(--accent-color);
        box-shadow: 0 5px 20px var(--shadow-color);
      }

      .song-card.selected {
        border-color: var(--accent-color);
        background: var(--bg-secondary);
      }

      .song-thumbnail {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.1);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      /* Video thumbnails should have 16:9 aspect ratio */
      .song-thumbnail.video-thumbnail {
        aspect-ratio: 16 / 9;
      }

      /* Lazy loading styles */
      .song-thumbnail:not(.loaded) {
        opacity: 0;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.1) 25%,
          rgba(255, 255, 255, 0.2) 50%,
          rgba(255, 255, 255, 0.1) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }

      .song-thumbnail.loaded {
        opacity: 1;
        transform: scale(1);
      }

      .song-thumbnail.loading {
        opacity: 0.7;
        transform: scale(0.95);
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      /* Lazy loading placeholder for larger images */
      .lazy-image-placeholder {
        width: 100%;
        border-radius: 10px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.1) 25%,
          rgba(255, 255, 255, 0.2) 50%,
          rgba(255, 255, 255, 0.1) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-tertiary);
        font-size: 0.9em;
        min-height: 200px;
      }

      .lazy-image {
        transition: opacity 0.4s ease, transform 0.4s ease;
        opacity: 0;
        transform: scale(0.9);
      }

      .lazy-image.loaded {
        opacity: 1;
        transform: scale(1);
      }

      .song-title {
        font-weight: bold;
        font-size: 1em;
        margin-bottom: 5px;
        color: #fff;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .song-artist {
        font-size: 0.9em;
        color: #aaa;
        margin-bottom: 10px;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .song-metadata {
        font-size: 0.8em;
        color: #888;
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .song-metadata span {
        display: inline-flex;
        align-items: center;
        gap: 3px;
      }

      .song-actions {
        display: flex;
        gap: 10px;
      }

      .download-btn {
        flex: 1;
        padding: 8px 15px;
        background: var(--accent-color);
        color: var(--bg-primary);
        border: 1px solid var(--accent-color);
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .download-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      .download-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .download-btn.downloading {
        background: var(--warning-color);
        color: #000;
        border-color: var(--warning-color);
      }

      .download-btn.queued {
        background: var(--text-secondary);
        color: white;
        border-color: var(--text-secondary);
        opacity: 0.8;
      }

      .download-btn.complete {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
      }

      .advanced-btn:hover {
        background: var(--primary-color) !important;
        transform: scale(1.05);
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      .advanced-btn:active {
        transform: scale(0.98);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }

      .empty-state i {
        font-size: 4em;
        margin-bottom: 20px;
        display: block;
      }

      .spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--accent-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
      }

      /* YouTube iframe responsive styles */
      .youtube-iframe-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .youtube-iframe-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
        border-radius: 10px;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8em;
        }

        .songs-grid {
          grid-template-columns: 1fr;
        }

        .search-input-group {
          flex-direction: column;
        }

        /* Mobile responsive for YouTube preview */
        .url-result-card .preview-grid {
          grid-template-columns: 1fr !important;
          gap: 15px !important;
        }

        .youtube-iframe-container {
          margin-bottom: 15px;
        }

        /* Mobile responsive for SoundCloud recommendations */
        .recommended-tracks-grid {
          grid-template-columns: 1fr !important;
        }
      }

      /* SoundCloud recommendations styling */
      .recommended-track-card {
        transition: all 0.3s ease;
      }

      .recommended-track-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .recommended-tracks-grid {
        animation: slideIn 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Theme</button>
        <h1>
          <a
            href="{{ frontend_url }}"
            style="text-decoration: none; color: inherit; cursor: pointer"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="display: inline-block; margin-right: 10px"
            >
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
            </svg>
            Universal Music Downloader
          </a>
        </h1>
        <p>
          Download high-quality music from YouTube, SoundCloud, JioSaavn & more
          <br />
          <a
            href="bulk.html"
            style="
              color: var(--accent-color);
              text-decoration: none;
              font-weight: 600;
              margin-top: 10px;
              display: inline-block;
            "
          >
            Bulk & Playlist Downloader â†’
          </a>
        </p>
      </div>

      <div class="search-box">
        <div class="search-type-selector">
          <button
            class="type-btn active"
            data-type="music"
            onclick="selectSearchType('music')"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 18V5l12-2v13"></path>
              <circle cx="6" cy="18" r="3"></circle>
              <circle cx="18" cy="16" r="3"></circle>
            </svg>
            Music
          </button>
          <button
            class="type-btn"
            data-type="video"
            onclick="selectSearchType('video')"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polygon points="23 7 16 12 23 17 23 7"></polygon>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg>
            Videos
          </button>
          <button
            class="type-btn"
            data-type="all"
            onclick="selectSearchType('all')"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path
                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
              ></path>
            </svg>
            All Sources
          </button>
        </div>

        <div class="search-input-group" style="position: relative">
          <input
            type="text"
            id="searchInput"
            placeholder="Enter song name, artist, or paste URL..."
            autocomplete="off"
          />
          <div id="searchSuggestions" class="search-suggestions"></div>
          <button id="searchBtn">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            Search
          </button>
        </div>

        <div id="queryHint" class="query-hint">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            style="display: inline-block; margin-right: 5px"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          Search by name or paste a music URL (YouTube, SoundCloud, JioSaavn
          etc.)
        </div>
      </div>

      <div id="status" class="status"></div>

      <!-- Source Navigation -->
      <div id="sourceNavigation" class="source-navigation"></div>

      <div id="results" class="results-container"></div>

      <!-- Download Manager -->
      <div id="downloadManager" class="download-manager">
        <div class="download-manager-header">
          <h3>
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7,10 12,15 17,10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Downloads
          </h3>
          <div class="download-manager-controls">
            <button onclick="clearFinishedDownloads()" title="Clear Finished">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="3,6 5,6 21,6"></polyline>
                <path
                  d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2"
                ></path>
              </svg>
            </button>
            <button onclick="toggleDownloadManager()" title="Close">Ã—</button>
          </div>
        </div>
        <div id="downloadList" class="download-list">
          <div
            style="
              padding: 20px;
              text-align: center;
              color: var(--text-secondary);
            "
          >
            No downloads yet
          </div>
        </div>
      </div>

      <!-- Download Manager Toggle Button -->
      <button
        id="downloadToggle"
        class="download-manager-toggle"
        onclick="toggleDownloadManager()"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7,10 12,15 17,10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span id="downloadBadge" class="badge" style="display: none">0</span>
      </button>
    </div>

    <script src="config.js"></script>
    <script>
      // Helper to get API base URL with fallback
      function getApiBaseUrl() {
        let url;
        if (window.API && window.API.baseUrl) {
          url = window.API.baseUrl;
        } else {
          // Fallback if config.js hasn't loaded yet
          const hostname = window.location.hostname;
          if (hostname === "localhost" || hostname === "127.0.0.1") {
            url = "http://localhost:5000";
          } else {
            // Production fallback
            url = "https://song-download-9889cf8e8f85.herokuapp.com";
          }
        }

        // Ensure no trailing slash
        if (url && url.endsWith("/")) {
          url = url.slice(0, -1);
        }

        return url || "https://song-download-9889cf8e8f85.herokuapp.com";
      }

      let currentSearchId = null;
      let selectedSongs = new Set();
      let searchType = "music"; // Default search type
      let advancedOptionsVisible = false;
      let downloadManagerVisible = false;
      let allDownloads = {};

      // Load downloads from localStorage on page load
      function loadDownloadsFromStorage() {
        try {
          const stored = localStorage.getItem("allDownloads");
          if (stored) {
            allDownloads = JSON.parse(stored);
            updateDownloadManager();
            updateDownloadBadge();
          }
        } catch (e) {
          console.error("Error loading downloads from storage:", e);
        }
      }

      // Save downloads to localStorage
      function saveDownloadsToStorage() {
        try {
          localStorage.setItem("allDownloads", JSON.stringify(allDownloads));
        } catch (e) {
          console.error("Error saving downloads to storage:", e);
        }
      }

      // Download Queue Management
      const MAX_CONCURRENT_DOWNLOADS = 3;
      let activeDownloads = 0;
      let downloadQueue = [];

      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const statusDiv = document.getElementById("status");
      const resultsDiv = document.getElementById("results");
      const queryHint = document.getElementById("queryHint");
      const searchSuggestions = document.getElementById("searchSuggestions");

      // Search Suggestions Management
      let suggestionsVisible = false;
      let currentSuggestions = [];
      let highlightedIndex = -1;
      let suggestionTimeout = null;

      // Enhanced status management utility
      function showStatus(type, title, subtitle = "", icon = null) {
        statusDiv.className = `status ${type} show`;

        let iconHTML = "";
        if (icon) {
          iconHTML = `<span class="status-icon">${icon}</span>`;
        } else if (type === "searching" || type === "info") {
          iconHTML = '<div class="spinner"></div>';
        } else {
          // Default icons for each type
          const defaultIcons = {
            success:
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            complete:
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            error:
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
            warning:
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><triangle path="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></triangle><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
          };
          iconHTML = `<span class="status-icon">${
            defaultIcons[type] || ""
          }</span>`;
        }

        const subtitleHTML = subtitle ? `<br><small>${subtitle}</small>` : "";
        statusDiv.innerHTML = `${iconHTML}<strong>${title}</strong>${subtitleHTML}`;
      }

      // Hide status with animation
      function hideStatus() {
        statusDiv.className = "status";
        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 300);
      }

      // Update download manager UI
      function updateDownloadManager() {
        const downloadList = document.getElementById("downloadList");
        const downloads = Object.entries(allDownloads);

        // Add queued items to the display
        const queuedItems = downloadQueue.map((item, index) => [
          `queue_${index}`,
          {
            ...item,
            status: "queued",
            progress: 0,
            timestamp: item.timestamp || Date.now(),
          },
        ]);

        const allItems = [...downloads, ...queuedItems];

        if (allItems.length === 0) {
          downloadList.innerHTML =
            '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No downloads yet</div>';
          return;
        }

        // Sort by timestamp (newest first)
        allItems.sort((a, b) => {
          const timeA = new Date(a[1].timestamp || 0);
          const timeB = new Date(b[1].timestamp || 0);
          return timeB - timeA;
        });

        downloadList.innerHTML = allItems
          .map(([downloadId, download]) => {
            const statusClass = download.status;
            const progressWidth = download.progress || 0;

            let statusIcon = "";
            switch (download.status) {
              case "queued":
                statusIcon =
                  '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';
                break;
              case "downloading":
                statusIcon =
                  '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
                break;
              case "complete":
                statusIcon =
                  '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                break;
              case "error":
                statusIcon =
                  '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                break;
              case "cancelled":
                statusIcon =
                  '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                break;
            }

            let actions = "";
            if (download.status === "queued") {
              // Only queued downloads can be cancelled from queue
              const queueIndex = downloadId.startsWith("queue_")
                ? downloadId.split("_")[1]
                : -1;
              actions = `<button class="cancel" onclick="cancelQueuedDownload(${queueIndex})">Remove</button>`;
            } else if (
              download.status === "complete" &&
              download.download_url
            ) {
              const fullUrl = download.download_url.startsWith("http")
                ? download.download_url
                : `${getApiBaseUrl()}${download.download_url}`;
              actions = `<button onclick="window.open('${fullUrl}', '_blank')">Download</button>`;
            }

            let timeInfo;
            if (download.status === "downloading") {
              timeInfo = `${download.speed || "0 KB/s"} â€¢ ETA: ${
                download.eta || "Unknown"
              }`;
            } else if (download.status === "queued") {
              const position = downloadId.startsWith("queue_")
                ? parseInt(downloadId.split("_")[1]) + 1
                : "Unknown";
              timeInfo = `Position ${position} in queue`;
            } else {
              timeInfo = new Date(download.timestamp).toLocaleString();
            }

            return `
                    <div class="download-item ${statusClass}">
                        <div class="download-title">${download.title}</div>
                        <div class="download-progress">
                            <div class="progress-bar">
                                <div class="progress-fill ${statusClass}" style="width: ${progressWidth}%"></div>
                            </div>
                        </div>
                        <div class="download-info">
                            <span>${statusIcon} ${progressWidth}% â€¢ ${timeInfo}</span>
                            <div class="download-actions">${actions}</div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // Update download badge
      function updateDownloadBadge() {
        const badge = document.getElementById("downloadBadge");
        const activeCount = Object.values(allDownloads).filter(
          (d) => d.status === "downloading"
        ).length;
        const queuedCount = downloadQueue.length;
        const totalActive = activeCount + queuedCount;

        if (totalActive > 0) {
          badge.textContent = totalActive;
          badge.style.display = "flex";
        } else {
          badge.style.display = "none";
        }
      }

      // Toggle download manager visibility
      function toggleDownloadManager() {
        const manager = document.getElementById("downloadManager");
        downloadManagerVisible = !downloadManagerVisible;

        if (downloadManagerVisible) {
          manager.classList.add("show");
        } else {
          manager.classList.remove("show");
        }
      }

      // Cancel download
      async function cancelDownload(downloadId) {
        try {
          const response = await fetch(
            `${getApiBaseUrl()}/cancel_download/${downloadId}`,
            {
              method: "POST",
            }
          );
          const result = await response.json();

          if (allDownloads[downloadId]) {
            allDownloads[downloadId].status = "cancelled";
            saveDownloadsToStorage();
            updateDownloadManager();
            updateDownloadBadge();
          }

          if (response.ok) {
            showNotification(result.message, "info");
          } else {
            showNotification(result.error, "error");
          }
        } catch (error) {
          showNotification("Failed to cancel download", "error");
        }
      }

      // Cancel queued download (remove from queue)
      function cancelQueuedDownload(queueIndex) {
        if (queueIndex >= 0 && queueIndex < downloadQueue.length) {
          const item = downloadQueue[queueIndex];

          // Find and reset the corresponding button
          const button = document.getElementById(item.buttonId);
          if (button) {
            button.className = "download-btn";
            button.innerHTML = "Download";
            button.disabled = false;
          }

          // Remove from queue
          downloadQueue.splice(queueIndex, 1);

          showNotification(`${item.title} removed from queue`, "info");
          updateDownloadManager();
          updateDownloadBadge();
        }
      }

      // Clear finished downloads
      async function clearFinishedDownloads() {
        for (let id in allDownloads) {
          if (
            allDownloads[id].status === "complete" ||
            allDownloads[id].status === "error" ||
            allDownloads[id].status === "cancelled"
          ) {
            delete allDownloads[id];
          }
        }
        saveDownloadsToStorage();
        updateDownloadManager();
        updateDownloadBadge();
        showNotification("Finished downloads cleared", "success");
      }

      // Handle browser back/forward navigation
      window.addEventListener("popstate", (event) => {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get("q");
        const type = urlParams.get("type");

        if (query) {
          searchInput.value = decodeURIComponent(query);
          if (type) {
            searchType = type;
          }
          // Auto-trigger search
          performSearch();
        } else {
          // Clear search if no query in URL
          searchInput.value = "";
          resultsDiv.innerHTML = "";
          statusDiv.innerHTML = "";
        }
      });

      // Add download to queue
      function queueDownload(url, title, button, useAdvanced = false) {
        const queueItem = {
          url,
          title,
          useAdvanced,
          status: "queued",
          timestamp: Date.now(),
          buttonId: button.id || `btn_${Date.now()}`, // Track button for updates
        };

        // Assign ID to button if it doesn't have one
        if (!button.id) {
          button.id = queueItem.buttonId;
        }

        downloadQueue.push(queueItem);

        // Update button to show queued status
        button.disabled = true;
        button.className = "download-btn queued";
        button.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
                Queued (${downloadQueue.length})
            `;

        showNotification(
          `${title} added to download queue (Position ${downloadQueue.length})`,
          "info"
        );

        // Update download manager
        updateDownloadManager();
        updateDownloadBadge();

        // Try to process queue
        processQueue();
      }

      // Process download queue
      function processQueue() {
        while (
          activeDownloads < MAX_CONCURRENT_DOWNLOADS &&
          downloadQueue.length > 0
        ) {
          const item = downloadQueue.shift();

          // Find and update the button status
          const button = document.getElementById(item.buttonId);
          if (button) {
            button.className = "download-btn downloading";
            button.innerHTML = '<div class="spinner"></div> Starting...';
          }

          // Start the download
          activeDownloads++;
          startDownload(item.url, item.title, item.useAdvanced, button);

          // Update download manager to reflect queue changes
          updateDownloadManager();
          updateDownloadBadge();
        }
      }

      // Search Suggestions Functions
      async function fetchSuggestions(query) {
        if (!query || query.length < 2) {
          hideSuggestions();
          return;
        }

        try {
          const response = await fetch(
            `${getApiBaseUrl()}/suggestions?q=${encodeURIComponent(query)}`
          );
          const data = await response.json();
          showSuggestions(data.suggestions || []);
        } catch (error) {
          hideSuggestions();
        }
      }

      function showSuggestions(suggestions) {
        currentSuggestions = suggestions;
        highlightedIndex = -1;

        if (suggestions.length === 0) {
          hideSuggestions();
          return;
        }

        searchSuggestions.innerHTML = suggestions
          .map(
            (suggestion, index) => `
                <div class="suggestion-item" data-index="${index}" onclick="selectSuggestion('${suggestion.replace(
              /'/g,
              "\\'"
            )}')">
                    <svg class="suggestion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <span class="suggestion-text">${suggestion}</span>
                </div>
            `
          )
          .join("");

        searchSuggestions.classList.add("show");
        suggestionsVisible = true;
      }

      function hideSuggestions() {
        searchSuggestions.classList.remove("show");
        suggestionsVisible = false;
        highlightedIndex = -1;
      }

      function selectSuggestion(suggestion) {
        searchInput.value = suggestion;
        hideSuggestions();
        performSearch();
      }

      function navigateSuggestions(direction) {
        if (!suggestionsVisible || currentSuggestions.length === 0) return;

        // Remove previous highlight
        const prevHighlighted = searchSuggestions.querySelector(
          ".suggestion-item.highlighted"
        );
        if (prevHighlighted) {
          prevHighlighted.classList.remove("highlighted");
        }

        // Update index
        if (direction === "down") {
          highlightedIndex = (highlightedIndex + 1) % currentSuggestions.length;
        } else if (direction === "up") {
          highlightedIndex =
            highlightedIndex <= 0
              ? currentSuggestions.length - 1
              : highlightedIndex - 1;
        }

        // Highlight new item
        const newHighlighted = searchSuggestions.querySelector(
          `[data-index="${highlightedIndex}"]`
        );
        if (newHighlighted) {
          newHighlighted.classList.add("highlighted");
          searchInput.value = currentSuggestions[highlightedIndex];
        }
      }

      // JioSaavn Async Suggestions Loading
      async function loadJioSaavnSuggestions(
        pid,
        sectionElement,
        language = "hindi"
      ) {
        const suggestionContainer = sectionElement.querySelector(
          "#jiosaavn-suggestions-container"
        );
        if (!suggestionContainer) return;

        try {
          const response = await fetch(
            `${getApiBaseUrl()}/jiosaavn_suggestions/${pid}?language=${language}`
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          // Build suggestions HTML
          let suggestionsHTML = "";

          if (data.suggestions && data.suggestions.length > 0) {
            suggestionsHTML = `
                        <h3 style="font-size: 1.4em; color: var(--info-color); margin-bottom: 15px; border-bottom: 2px solid var(--info-color); padding-bottom: 8px;">
                            Recommended Tracks (${data.suggestions.length})
                        </h3>
                        <div class="jiosaavn-suggestions-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    `;

            data.suggestions.forEach((track) => {
              // Use direct src for JioSaavn images to avoid lazy loading issues
              const trackThumbnail = track.thumbnail
                ? track.thumbnail
                : "data:image/svg+xml;base64," +
                  btoa(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><rect width="120" height="120" fill="#2a2a2a"/><circle cx="60" cy="60" r="35" fill="none" stroke="#555" stroke-width="2"/><circle cx="60" cy="60" r="15" fill="none" stroke="#555" stroke-width="1.5"/><circle cx="60" cy="60" r="3" fill="#555"/><path d="M60 25 L75 35 L75 40 L60 30 Z" fill="#666"/><text x="60" y="100" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#777">No Image</text></svg>'
                  );

              suggestionsHTML += `
                            <div class="jiosaavn-suggestion-card" style="background: var(--bg-card); border-radius: 10px; padding: 15px; border: 1px solid var(--border-color);">
                                <div style="display: flex; gap: 12px;">
                                    <div style="flex-shrink: 0;">
                                        <img src="${trackThumbnail}" alt="${
                track.title
              }" loading="lazy" style="width: 60px; height: 60px; border-radius: 6px; object-fit: cover;" />
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <h5 style="font-size: 1em; margin-bottom: 4px; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${
                                          track.title
                                        }</h5>
                                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 6px;">${
                                          track.artist
                                        }</p>
                                        ${
                                          track.album
                                            ? `<p style="font-size: 0.75em; color: var(--text-tertiary); margin-bottom: 6px;">Album: ${track.album}</p>`
                                            : ""
                                        }
                                        <div style="display: flex; gap: 6px;">
                                            <button class="download-btn" style="flex: 1; padding: 6px 10px; font-size: 0.85em;" onclick="downloadSong('${
                                              track.url
                                            }', '${track.title.replace(
                /'/g,
                "\\'"
              )}', this, true)">
                                                Download
                                            </button>
                                            <button class="advanced-btn" style="padding: 6px 8px; font-size: 0.85em;" onclick="openAdvancedDownload('${
                                              track.url
                                            }', '${track.title.replace(
                /'/g,
                "\\'"
              )}', this)" title="Advanced Options">
                                                âš™
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
            });

            suggestionsHTML += "</div>";
          } else {
            suggestionsHTML = `
                        <h3 style="font-size: 1.4em; color: var(--info-color); margin-bottom: 15px;">Recommended Tracks</h3>
                        <p style="color: var(--text-secondary); font-style: italic;">No recommendations found for this track.</p>
                    `;
          }

          // Update the container
          suggestionContainer.innerHTML = suggestionsHTML;

          // Initialize lazy loading for the new images
          initLazyLoading();
        } catch (error) {
          suggestionContainer.innerHTML = `
                    <h3 style="font-size: 1.4em; color: var(--error-color); margin-bottom: 15px;">Recommended Tracks</h3>
                    <p style="color: var(--text-secondary); font-style: italic;">Failed to load recommendations. ${error.message}</p>
                `;
        }
      }

      // Theme Toggle
      function toggleTheme() {
        document.body.classList.toggle("light-theme");
        const isLight = document.body.classList.contains("light-theme");
        const themeIcon = document.getElementById("themeIcon");

        if (isLight) {
          themeIcon.innerHTML =
            '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
          document.getElementById("themeText").textContent = "Light";
        } else {
          themeIcon.innerHTML =
            '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
          document.getElementById("themeText").textContent = "Dark";
        }

        localStorage.setItem("theme", isLight ? "light" : "dark");
      }

      // Load saved theme and downloads
      window.addEventListener("DOMContentLoaded", () => {
        loadDownloadsFromStorage();
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "light") {
          document.body.classList.add("light-theme");
          const themeIcon = document.getElementById("themeIcon");
          themeIcon.innerHTML =
            '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
          document.getElementById("themeText").textContent = "Light";
        }

        // Check for URL parameters and auto-search
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get("q");
        const type = urlParams.get("type");

        if (query) {
          searchInput.value = decodeURIComponent(query);
          if (type) {
            searchType = type;
            // Update button UI to reflect the type from URL
            selectSearchType(type);
          }
          // Auto-trigger search
          setTimeout(() => {
            performSearch();
          }, 500);
        } else if (type) {
          // Even without query, if type is specified, update the button
          searchType = type;
          selectSearchType(type);
        }
      });

      // Toggle Advanced Options
      function toggleAdvanced() {
        advancedOptionsVisible = !advancedOptionsVisible;
        const advOpts = document.getElementById("advancedOptions");
        const toggleText = document.getElementById("advancedToggleText");

        if (advancedOptionsVisible) {
          advOpts.classList.add("show");
          toggleText.textContent = "Hide Download Options";
        } else {
          advOpts.classList.remove("show");
          toggleText.textContent = "Show Download Options";
        }
      }

      // Switch between Basic and Advanced tabs
      function switchOptionsTab(tabName) {
        // Remove active class from all tabs and contents
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".options-tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active class to selected tab
        event.target.classList.add("active");
        document.getElementById(`${tabName}OptionsTab`).classList.add("active");
      }

      // Toggle Download Type Options
      function toggleDownloadOptions() {
        const downloadType = document.getElementById("downloadType").value;
        const audioOptions = document.getElementById("audioOptions");

        if (downloadType === "audio") {
          audioOptions.style.display = "block";
        } else {
          audioOptions.style.display = "none";
        }
      }

      // Toggle playlist items input based on playlist option
      document.addEventListener("DOMContentLoaded", () => {
        const playlistOption = document.getElementById("playlistOption");
        const playlistItemsGroup =
          document.getElementById("playlistItemsGroup");

        if (playlistOption) {
          playlistOption.addEventListener("change", (e) => {
            if (e.target.value === "playlist-items") {
              playlistItemsGroup.style.display = "block";
            } else {
              playlistItemsGroup.style.display = "none";
            }
          });
        }
      });

      // Detect URL in input and show suggestions
      searchInput.addEventListener("input", () => {
        const query = searchInput.value.trim();

        // Clear timeout for previous suggestions request
        if (suggestionTimeout) {
          clearTimeout(suggestionTimeout);
        }

        // Clear URL if input is empty
        if (!query) {
          const newUrl = new URL(window.location);
          newUrl.searchParams.delete("q");
          newUrl.searchParams.delete("type");
          window.history.replaceState({}, "", newUrl.pathname);
          resultsDiv.innerHTML = "";
          statusDiv.innerHTML = "";
          hideSuggestions();
          return;
        }

        // Check if it's a MUSIC-related URL (not just any URL)
        const isMusicUrl =
          /youtube\.com\/watch|youtu\.be\/|music\.youtube\.com|jiosaavn\.com\/|saavn\.com\/|soundcloud\.com\/|spotify\.com\/|gaana\.com\/|wynk\.in\//i.test(
            query
          );

        // Check if it's ANY URL (including non-music URLs)
        const isAnyUrl = /https?:\/\/|www\./i.test(query);

        if (isMusicUrl) {
          queryHint.className = "query-hint url-detected";
          queryHint.innerHTML =
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 5px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>Music URL detected! Click search to download.';
          hideSuggestions(); // Hide suggestions for URLs
        } else if (isAnyUrl) {
          // It's a URL but not a music URL - show error
          queryHint.className = "query-hint";
          queryHint.style.color = "var(--error-color)";
          queryHint.innerHTML =
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 5px;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Invalid URL! Only music URLs supported (YouTube, SoundCloud, JioSaavn, Spotify, etc.)';
          hideSuggestions(); // Hide suggestions for invalid URLs
        } else {
          queryHint.className = "query-hint";
          queryHint.style.color = "";
          queryHint.innerHTML =
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 5px;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Search by name or paste a music URL (YouTube, SoundCloud, JioSaavn, Spotify, etc.)';

          // Show suggestions for search queries (debounced)
          suggestionTimeout = setTimeout(() => {
            fetchSuggestions(query);
          }, 300); // 300ms delay to avoid too many requests
        }
      });

      // Select search type
      function selectSearchType(type) {
        searchType = type;

        // Update button states
        document.querySelectorAll(".type-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.getAttribute("data-type") === type) {
            btn.classList.add("active");
          }
        });

        // Update search button text
        const btnText = {
          music: "Search Music",
          video: "Search Videos",
          all: "Search All Sources",
        };
        searchBtn.innerHTML = btnText[type] || "Search";

        // Update URL if there's an active search
        const query = searchInput.value.trim();
        if (query) {
          const newUrl = new URL(window.location);
          newUrl.searchParams.set("q", encodeURIComponent(query));
          newUrl.searchParams.set("type", searchType);
          window.history.replaceState({}, "", newUrl);
        }
      }

      // Search on Enter key and handle suggestion navigation
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          if (suggestionsVisible && highlightedIndex >= 0) {
            // Select highlighted suggestion
            selectSuggestion(currentSuggestions[highlightedIndex]);
          } else {
            // Perform normal search
            hideSuggestions();
            performSearch();
          }
        } else if (e.key === "ArrowDown") {
          e.preventDefault();
          navigateSuggestions("down");
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          navigateSuggestions("up");
        } else if (e.key === "Escape") {
          hideSuggestions();
        }
      });

      // Hide suggestions when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !searchInput.contains(e.target) &&
          !searchSuggestions.contains(e.target)
        ) {
          hideSuggestions();
        }
      });

      // Search button click
      searchBtn.addEventListener("click", performSearch);

      async function performSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        // Check if it's a MUSIC-related URL
        const isMusicUrl =
          /youtube\.com\/watch|youtu\.be\/|music\.youtube\.com|jiosaavn\.com\/|saavn\.com\/|soundcloud\.com\/|spotify\.com\/|gaana\.com\/|wynk\.in\//i.test(
            query
          );

        // Check if it's ANY URL (including non-music URLs)
        const isAnyUrl = /https?:\/\/|www\./i.test(query);

        // If it's a URL but NOT a music URL, show error and stop
        if (isAnyUrl && !isMusicUrl) {
          showStatus(
            "error",
            "Invalid URL!",
            "Only music platform URLs are supported (YouTube, SoundCloud, JioSaavn, Spotify, etc.)"
          );
          return;
        }

        // Update URL with search query
        const newUrl = new URL(window.location);
        newUrl.searchParams.set("q", encodeURIComponent(query));
        newUrl.searchParams.set("type", searchType);
        window.history.pushState({}, "", newUrl);

        // Clear previous results and navigation
        resultsDiv.innerHTML = "";
        const sourceNavigation = document.getElementById("sourceNavigation");
        if (sourceNavigation) {
          sourceNavigation.innerHTML = "";
          sourceNavigation.className = "source-navigation";
        }
        selectedSongs.clear();

        // Show searching status with improved styling
        if (isMusicUrl) {
          showStatus(
            "searching",
            "Processing URL...",
            "Extracting music information"
          );

          // Set up 20-second timeout for URL processing (increased for better handling)
          const urlTimeoutId = setTimeout(() => {
            showStatus(
              "info",
              "Still processing...",
              "URL analysis is taking longer than expected. Please wait..."
            );
          }, 20000);

          // For URLs, use the original single endpoint approach
          try {
            const response = await fetch(`${getApiBaseUrl()}/search`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                query: query,
                type: searchType,
              }),
            });

            const data = await response.json();
            currentSearchId = data.search_id;

            // Clear the timeout since we got a response
            clearTimeout(urlTimeoutId);

            // Poll for results
            pollSearchResults();
          } catch (error) {
            clearTimeout(urlTimeoutId);
            showStatus(
              "error",
              "URL processing failed!",
              "Please check the URL and try again"
            );
            searchBtn.disabled = false;
          }
        } else {
          // For search queries, use parallel endpoint approach for faster results
          showStatus(
            "searching",
            "Searching all platforms...",
            "JioSaavn â€¢ SoundCloud â€¢ YouTube Music"
          );

          // Set up 20-second timeout for search queries (increased for better handling)
          const searchTimeoutId = setTimeout(() => {
            showStatus(
              "info",
              "Search is taking a bit longer...",
              "Connecting to music services (JioSaavn, SoundCloud, etc). Please wait..."
            );
          }, 20000);

          // Disable search button
          searchBtn.disabled = true;

          // Initialize results container
          const allResults = {
            jiosaavn: [],
            soundcloud: [],
            ytmusic: [],
            ytvideo: [],
          };

          // Track completed requests
          let completedSources = 0;
          const totalSources =
            searchType === "music" ? 3 : searchType === "video" ? 1 : 4;

          // Define which endpoints to call based on search type
          const endpoints = [];
          if (searchType === "music" || searchType === "all") {
            endpoints.push("jiosaavn", "soundcloud", "ytmusic");
          }
          if (searchType === "video" || searchType === "all") {
            endpoints.push("ytvideo");
          }

          // Function to handle results from each source
          const handleSourceResult = (source, data) => {
            allResults[source] = data.results || [];
            completedSources++;

            // Clear the timeout once we start getting results
            if (completedSources === 1) {
              clearTimeout(searchTimeoutId);
            }

            // Update status to show progress
            const completedNames = [];
            if (allResults.jiosaavn.length > 0)
              completedNames.push(`JioSaavn (${allResults.jiosaavn.length})`);
            if (allResults.soundcloud.length > 0)
              completedNames.push(
                `SoundCloud (${allResults.soundcloud.length})`
              );
            if (allResults.ytmusic.length > 0)
              completedNames.push(`YTMusic (${allResults.ytmusic.length})`);
            if (allResults.ytvideo.length > 0)
              completedNames.push(`YTVideo (${allResults.ytvideo.length})`);

            if (completedNames.length > 0) {
              showStatus(
                "searching",
                `Found results: ${completedNames.join(" â€¢ ")}`,
                `${completedSources}/${totalSources} sources completed`
              );

              // Display results immediately as they arrive
              displayResults({
                jiosaavn: allResults.jiosaavn,
                soundcloud: allResults.soundcloud,
                ytmusic: allResults.ytmusic,
                ytvideo: allResults.ytvideo,
              });
            }

            // Check if all sources completed
            if (completedSources >= totalSources) {
              clearTimeout(searchTimeoutId);
              const totalResults =
                allResults.jiosaavn.length +
                allResults.soundcloud.length +
                allResults.ytmusic.length +
                allResults.ytvideo.length;

              if (totalResults > 0) {
                showStatus(
                  "complete",
                  `Search completed!`,
                  `Found ${totalResults} results across all platforms`
                );
              } else {
                showStatus(
                  "warning",
                  "No results found",
                  "Try different keywords or check spelling"
                );
              }
              searchBtn.disabled = false;
            }
          };

          // Make parallel requests to all endpoints
          const promises = endpoints.map(async (source) => {
            try {
              const response = await fetch(
                `${getApiBaseUrl()}/search/${source}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    query: query,
                    type: searchType,
                  }),
                }
              );

              const data = await response.json();
              handleSourceResult(source, data);
            } catch (error) {
              handleSourceResult(source, { results: [] });
            }
          });

          // Don't wait for all - results will be displayed as they arrive
          Promise.allSettled(promises).finally(() => {
            clearTimeout(searchTimeoutId);
          });
        }
      }

      async function pollSearchResults() {
        if (!currentSearchId) return;

        try {
          const response = await fetch(
            `${getApiBaseUrl()}/search_status/${currentSearchId}`
          );
          const data = await response.json();

          if (data.status === "complete") {
            displayResults(data);
            statusDiv.className = "status complete show";

            // Calculate total with all sources including SoundCloud
            const total =
              (data.ytmusic?.length || 0) +
              (data.ytvideo?.length || 0) +
              (data.jiosaavn?.length || 0) +
              (data.soundcloud?.length || 0) +
              (data.direct_url?.length || 0);

            if (data.query_type === "url") {
              statusDiv.innerHTML =
                total > 0
                  ? '<span class="status-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></span><strong>Info extracted successfully!</strong><br><small>Ready to download your content</small>'
                  : '<span class="status-icon">!</span><strong>Could not extract info from URL</strong><br><small>Please check the URL and try again</small>';
            } else {
              statusDiv.innerHTML = `<span class="status-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></span><strong>Search complete!</strong><br><small>Found ${total} result${
                total !== 1 ? "s" : ""
              } across all sources</small>`;
            }

            searchBtn.disabled = false;
          } else {
            // Keep polling
            setTimeout(pollSearchResults, 500);
          }
        } catch (error) {
          statusDiv.className = "status error show";
          statusDiv.innerHTML =
            '<span class="status-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></span><strong>Connection lost!</strong><br><small>Unable to fetch search results</small>';
          searchBtn.disabled = false;
        }
      }

      async function displayResults(data) {
        resultsDiv.innerHTML = "";

        // Check if it's a direct URL result
        if (
          data.query_type === "url" &&
          data.direct_url &&
          data.direct_url.length > 0
        ) {
          // Show loading state immediately
          statusDiv.className = "status info show";
          statusDiv.innerHTML =
            '<div class="spinner"></div><strong>Processing URL...</strong><br><small>Extracting media information</small>';

          // Scroll to results area immediately
          resultsDiv.scrollIntoView({ behavior: "smooth", block: "start" });

          // Create and display loading section
          const loadingSection = document.createElement("div");
          loadingSection.className = "source-section active";
          loadingSection.style.maxWidth = "900px";
          loadingSection.style.margin = "0 auto";
          loadingSection.innerHTML = `
                    <div class="source-header">
                        <h2><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 8px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>${data.direct_url[0].source} - Loading...</h2>
                    </div>
                    <div class="url-result-card" style="background: var(--bg-card); padding: 40px; border-radius: 15px; border: 2px solid var(--accent-color); text-align: center;">
                        <div class="loading-spinner" style="margin: 20px auto;">
                            <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--accent-color); animation: spin 1s linear infinite;"></div>
                        </div>
                        <p style="color: var(--text-secondary); margin-top: 20px; font-size: 1.1em;">â³ Fetching preview data...</p>
                        <p style="color: var(--text-tertiary); margin-top: 10px; font-size: 0.9em;">Using cached tokens for instant results</p>
                    </div>
                `;
          resultsDiv.appendChild(loadingSection);

          // Fetch actual content
          const section = await createDirectUrlSection(data.direct_url[0]);

          // Replace loading with actual content
          resultsDiv.innerHTML = "";
          resultsDiv.appendChild(section);

          // Initialize lazy loading for the preview image
          setTimeout(() => {
            initLazyLoadingForNewImages();
          }, 0);

          // Update status and scroll to final result
          statusDiv.className = "status complete show";
          statusDiv.innerHTML =
            '<span class="status-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></span><strong>Ready to download!</strong><br><small>All options configured and ready</small>';

          // Smooth scroll to the results
          setTimeout(() => {
            resultsDiv.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 100);

          return;
        }

        // Create source navigation - REORDERED: JioSaavn, YouTube Music, SoundCloud, then YouTube Videos
        const sources = [];
        if (data.jiosaavn && data.jiosaavn.length > 0) {
          sources.push({
            id: "jiosaavn",
            name: "JioSaavn",
            count: data.jiosaavn.length,
            data: data.jiosaavn,
          });
        }
        if (data.ytmusic && data.ytmusic.length > 0) {
          sources.push({
            id: "ytmusic",
            name: "YouTube Music",
            count: data.ytmusic.length,
            data: data.ytmusic,
          });
        }
        if (data.soundcloud && data.soundcloud.length > 0) {
          sources.push({
            id: "soundcloud",
            name: "SoundCloud",
            count: data.soundcloud.length,
            data: data.soundcloud,
          });
        }
        if (data.ytvideo && data.ytvideo.length > 0) {
          sources.push({
            id: "ytvideo",
            name: "YouTube Videos",
            count: data.ytvideo.length,
            data: data.ytvideo,
          });
        }

        if (sources.length === 0) {
          resultsDiv.innerHTML =
            '<div class="empty-state"><i>âˆ…</i><h3>No results found</h3><p>Try a different search query</p></div>';
          return;
        }

        // Create navigation buttons
        const navDiv = document.getElementById("sourceNavigation");
        navDiv.innerHTML = "";
        navDiv.className = "source-navigation active";

        sources.forEach((source, index) => {
          const btn = document.createElement("button");
          btn.className = "source-nav-btn" + (index === 0 ? " active" : "");
          btn.innerHTML = `${source.name} <span class="count">${source.count}</span>`;
          btn.onclick = () => switchSource(source.id);
          navDiv.appendChild(btn);
        });

        // Create source sections
        sources.forEach((source, index) => {
          const section = createSourceSection(
            source.name,
            source.data,
            source.id
          );
          section.className = "source-section" + (index === 0 ? " active" : "");
          resultsDiv.appendChild(section);
        });

        // Initialize lazy loading for all newly added images
        setTimeout(() => {
          initLazyLoadingForNewImages();
        }, 0);
      }

      function switchSource(sourceId) {
        // Update navigation buttons
        document.querySelectorAll(".source-nav-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update source sections
        document.querySelectorAll(".source-section").forEach((section) => {
          section.classList.remove("active");
        });
        document.getElementById(sourceId).classList.add("active");

        // Scroll to results
        resultsDiv.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // Helper function to convert YouTube Music URLs to regular YouTube URLs and extract video ID
      function convertYouTubeMusicUrl(url) {
        // Convert music.youtube.com to youtube.com
        let convertedUrl = url.replace("music.youtube.com", "youtube.com");

        // Extract video ID from various YouTube URL formats
        let videoId = null;
        const patterns = [
          /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
          /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
          /youtube\.com\/.*[?&]v=([a-zA-Z0-9_-]{11})/,
        ];

        for (const pattern of patterns) {
          const match = convertedUrl.match(pattern);
          if (match) {
            videoId = match[1];
            break;
          }
        }

        return {
          convertedUrl: videoId
            ? `https://youtube.com/watch?v=${videoId}`
            : convertedUrl,
          videoId: videoId,
          embedUrl: videoId ? `https://youtube.com/embed/${videoId}` : null,
        };
      }

      // Helper function to create YouTube iframe
      function createYouTubeIframe(videoId, title = "YouTube Video") {
        if (!videoId) return "";

        return `
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe 
                        width="100%" 
                        height="100%" 
                        src="https://www.youtube-nocookie.com/embed/${videoId}?modestbranding=1" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"
                        style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;"
                        title="${title}">
                    </iframe>
                </div>
            `;
      }

      async function createDirectUrlSection(info) {
        const section = document.createElement("div");
        section.className = "source-section active";
        section.style.maxWidth = "900px";
        section.style.margin = "0 auto";

        // Handle YouTube Music URL conversion
        let processedInfo = { ...info };
        let youtubeData = null;

        if (
          info.source === "YouTube" &&
          (info.url.includes("music.youtube.com") ||
            info.url.includes("youtube.com") ||
            info.url.includes("youtu.be"))
        ) {
          youtubeData = convertYouTubeMusicUrl(info.url);
          processedInfo.url = youtubeData.convertedUrl;
          processedInfo.source = "YouTube";
        }

        // Fetch preview info from backend (FAST - uses search API cache)
        let previewData = null;
        try {
          const previewResponse = await fetch(
            `${getApiBaseUrl()}/preview_url`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url: processedInfo.url }),
            }
          );

          if (previewResponse.ok) {
            previewData = await previewResponse.json();
          } else {
            // Handle error responses (invalid URLs)
            const errorData = await previewResponse.json();
            if (errorData.error) {
              showStatus("error", "Invalid URL", errorData.error);
              return;
            }
          }
        } catch (error) {
          // Could not fetch preview - show error
          showStatus(
            "error",
            "Invalid URL",
            "Unable to process the provided URL"
          );
          return;
        }

        // Determine if this is a video or music URL based on searchType parameter
        // Use the current searchType which reflects the user's choice or URL parameter
        let urlMode = searchType; // Use global searchType (music/video/all)

        // If searchType is 'all', fallback to URL-based detection
        if (searchType === "all") {
          if (info.url.includes("music.youtube.com")) {
            urlMode = "music";
          } else if (
            info.url.includes("youtube.com/watch") ||
            info.url.includes("youtu.be/")
          ) {
            urlMode = "video";
          } else if (
            info.source === "SoundCloud" ||
            info.source === "JioSaavn"
          ) {
            urlMode = "music";
          } else {
            urlMode = "music"; // default to music
          }
        }

        // URL Mode detection and preview HTML building continues...

        // Build preview HTML
        let previewHTML = "";

        // Check if this is a YouTube URL with iframe support
        if (youtubeData && youtubeData.videoId) {
          // YouTube URL with iframe
          const channelName = previewData
            ? previewData.uploader || previewData.channel || "Unknown Channel"
            : "Unknown Channel";
          const videoTitle = previewData ? previewData.title : "YouTube Video";

          previewHTML = `
                    <div class="preview-grid" style="display: grid; grid-template-columns: 560px 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            ${createYouTubeIframe(
                              youtubeData.videoId,
                              videoTitle
                            )}
                        </div>
                        <div>
                            <h3 style="font-size: 1.6em; margin-bottom: 12px; color: var(--text-primary); line-height: 1.3;">${videoTitle}</h3>
                            <div style="color: var(--text-secondary); margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>Channel:</strong> ${channelName}</p>
                                <p style="margin: 5px 0;"><strong>Source:</strong> ${
                                  processedInfo.source
                                }</p>
                                <p style="margin: 5px 0; font-size: 0.9em; color: var(--text-tertiary);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 5px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                                    <a href="${
                                      processedInfo.url
                                    }" target="_blank" style="color: var(--accent-color); text-decoration: none;">${
            processedInfo.url
          }</a>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
        } else if (
          previewData &&
          previewData.soundcloud_data &&
          previewData.source === "SoundCloud"
        ) {
          // Enhanced SoundCloud preview with main track + recommendations
          const soundcloudData = previewData.soundcloud_data;
          const mainTrack = soundcloudData.main_track;
          const recommendedTracks = soundcloudData.recommended_tracks || [];

          // Use direct thumbnail URL for JioSaavn to avoid proxy issues
          const thumbnail = mainTrack.thumbnail
            ? mainTrack.thumbnail
            : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23333"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23666">â™ª</text></svg>';

          // Main track preview
          previewHTML = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 1.4em; margin-bottom: 15px; color: var(--accent-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">
                            Main Track
                        </h3>
                        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                            <div>
                                <img src="${thumbnail}" alt="${
            mainTrack.title
          }" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" />
                            </div>
                            <div>
                                <h4 style="font-size: 1.3em; margin-bottom: 8px; color: var(--text-primary);">${
                                  mainTrack.title
                                }</h4>
                                <div style="color: var(--text-secondary); margin-bottom: 12px;">
                                    <p style="margin: 3px 0;"><strong>Artist:</strong> ${
                                      mainTrack.artist
                                    }</p>
                                    <p style="margin: 3px 0;"><strong>Duration:</strong> ${
                                      mainTrack.duration
                                    }</p>
                                    <p style="margin: 3px 0;"><strong>Plays:</strong> ${
                                      mainTrack.plays
                                        ? mainTrack.plays.toLocaleString()
                                        : "0"
                                    }</p>
                                    <p style="margin: 3px 0;"><strong>Likes:</strong> ${
                                      mainTrack.likes
                                        ? mainTrack.likes.toLocaleString()
                                        : "0"
                                    }</p>
                                    ${
                                      mainTrack.genre
                                        ? `<p style="margin: 3px 0;"><strong>Genre:</strong> ${mainTrack.genre}</p>`
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;

          // Store SoundCloud recommendations for later display (after download options)
          if (recommendedTracks.length > 0) {
            previewData.soundcloud_recommendations = recommendedTracks;
          }
        } else if (previewData && !previewData.error && previewData.thumbnail) {
          // Full preview with thumbnail (non-YouTube or fallback)
          const thumbnail = previewData.thumbnail
            ? previewData.thumbnail
            : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23333"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23666">No Thumbnail</text></svg>';

          previewHTML = `
                    <div style="display: grid; grid-template-columns: 320px 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            ${createLazyImage(
                              thumbnail,
                              "Thumbnail",
                              "lazy-image",
                              "width: 100%; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);"
                            )}
                        </div>
                        <div>
                            <h3 style="font-size: 1.6em; margin-bottom: 12px; color: var(--text-primary); line-height: 1.3;">${
                              previewData.title
                            }</h3>
                            <div style="color: var(--text-secondary); margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>${
                                  previewData.source === "JioSaavn"
                                    ? "ðŸŽ¤ Artist:"
                                    : previewData.source === "SoundCloud"
                                    ? "ðŸŽ¤ Artist:"
                                    : "ðŸ“º Channel:"
                                }</strong> ${
            previewData.uploader || previewData.channel
          }</p>
                                ${
                                  previewData.album
                                    ? `<p style="margin: 5px 0;"><strong>ðŸ’½ Album:</strong> ${previewData.album}</p>`
                                    : ""
                                }
                                ${
                                  previewData.duration
                                    ? `<p style="margin: 5px 0;"><strong>â±ï¸ Duration:</strong> ${previewData.duration}</p>`
                                    : ""
                                }
                                ${
                                  previewData.plays
                                    ? `<p style="margin: 5px 0;"><strong>â–¶ï¸ Plays:</strong> ${previewData.plays.toLocaleString()}</p>`
                                    : ""
                                }
                                ${
                                  previewData.likes
                                    ? `<p style="margin: 5px 0;"><strong>â¤ï¸ Likes:</strong> ${previewData.likes.toLocaleString()}</p>`
                                    : ""
                                }
                                ${
                                  previewData.genre
                                    ? `<p style="margin: 5px 0;"><strong>ðŸŽ­ Genre:</strong> ${previewData.genre}</p>`
                                    : ""
                                }
                                <p style="margin: 5px 0;"><strong>ðŸ”— Source:</strong> ${
                                  previewData.source || processedInfo.source
                                }</p>
                            </div>
                        </div>
                    </div>
                `;
        } else if (previewData && !previewData.error) {
          // Basic preview without thumbnail
          previewHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 1.6em; margin-bottom: 12px; color: var(--text-primary);">${
                          previewData.title
                        }</h3>
                        <p style="color: var(--text-secondary); margin: 5px 0;"><strong>${
                          previewData.source === "JioSaavn"
                            ? "ðŸŽ¤ Artist:"
                            : previewData.source === "SoundCloud"
                            ? "ðŸŽ¤ Artist:"
                            : "ðŸ“º Channel:"
                        }</strong> ${
            previewData.uploader || previewData.channel
          }</p>
                        ${
                          previewData.album
                            ? `<p style="color: var(--text-secondary); margin: 5px 0;"><strong>ðŸ’½ Album:</strong> ${previewData.album}</p>`
                            : ""
                        }
                        ${
                          previewData.duration
                            ? `<p style="color: var(--text-secondary); margin: 5px 0;"><strong>â±ï¸ Duration:</strong> ${previewData.duration}</p>`
                            : ""
                        }
                        ${
                          previewData.plays
                            ? `<p style="color: var(--text-secondary); margin: 5px 0;"><strong>â–¶ï¸ Plays:</strong> ${previewData.plays.toLocaleString()}</p>`
                            : ""
                        }
                        ${
                          previewData.likes
                            ? `<p style="color: var(--text-secondary); margin: 5px 0;"><strong>â¤ï¸ Likes:</strong> ${previewData.likes.toLocaleString()}</p>`
                            : ""
                        }
                        ${
                          previewData.genre
                            ? `<p style="color: var(--text-secondary); margin: 5px 0;"><strong>ðŸŽ­ Genre:</strong> ${previewData.genre}</p>`
                            : ""
                        }
                        <p style="color: var(--text-secondary); margin: 5px 0;"><strong>ðŸ”— Source:</strong> ${
                          previewData.source || processedInfo.source
                        }</p>
                    </div>
                `;
        } else {
          // Fallback if preview fails - show basic URL info
          previewHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 1.8em; margin-bottom: 10px; color: var(--accent-color);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 8px;"><polyline points="20 6 9 17 4 12"></polyline></svg>URL Validated
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 1.1em; margin-bottom: 10px;">
                            <strong>ðŸ”— Source:</strong> ${processedInfo.source}
                        </p>
                        <p style="color: var(--text-tertiary); font-size: 0.9em; word-break: break-all;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 5px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>${processedInfo.url}
                        </p>
                    </div>
                `;
        }

        section.innerHTML = `
                <div class="source-header">
                    <h2><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 8px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>${
                      processedInfo.source
                    } - Ready to Download</h2>
                </div>
                <div class="url-result-card" style="background: var(--bg-card); padding: 30px; border-radius: 15px; border: 2px solid var(--accent-color);">
                    ${previewHTML}
                    
                    <!-- Download Options with Tabs (moved above recommendations) -->
                    <div style="margin-bottom: 20px;">
                        <button class="advanced-toggle" onclick="toggleAdvanced()" style="width: 100%; text-align: center; margin-bottom: 10px;">
                             <span id="advancedToggleText">Show Download Options</span>
                        </button>
                        <div id="advancedOptions" class="advanced-options">
                            <!-- Tab Headers -->
                            <div class="options-tabs">
                                <button class="tab-btn active" onclick="switchOptionsTab('basic')">
                                    ðŸ“¦ Basic
                                </button>
                                <button class="tab-btn" onclick="switchOptionsTab('advanced')">
                                    âš¡ Advanced
                                </button>
                            </div>

                            <!-- Basic Options Tab -->
                            <div id="basicOptionsTab" class="options-tab-content active">
                                <!-- Show different options based on URL mode (not global searchType) -->
                                ${
                                  urlMode === "video"
                                    ? `
                                    <!-- Video Quality Options (YouTube only) -->
                                    ${
                                      info.source === "YouTube"
                                        ? `
                                        <div class="option-row">
                                            <div class="option-group">
                                                <label>Video Quality</label>
                                                <select id="videoQuality">
                                                    <option value="2160">ðŸŽ¬ 4K (2160p)</option>
                                                    <option value="1440">ðŸŽ¬ 2K (1440p)</option>
                                                    <option value="1080" selected>ðŸŽ¬ Full HD (1080p)</option>
                                                    <option value="720">ðŸŽ¬ HD (720p)</option>
                                                    <option value="480">ðŸ“º SD (480p)</option>
                                                    <option value="360">ðŸ“º Low (360p)</option>
                                                    <option value="best">â­ Best Available</option>
                                                </select>
                                            </div>
                                            <div class="option-group">
                                                <label>Frame Rate</label>
                                                <select id="videoFPS">
                                                    <option value="60">60 FPS (Smooth)</option>
                                                    <option value="30" selected>30 FPS (Standard)</option>
                                                    <option value="any">Any FPS</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="option-row">
                                            <div class="option-group">
                                                <label>Video Format</label>
                                                <select id="videoFormat">
                                                    <option value="mkv" selected>MKV (High Quality)</option>
                                                    <option value="mp4">MP4 (Compatible)</option>
                                                    <option value="webm">WebM (Small Size)</option>
                                                </select>
                                            </div>
                                        </div>
                                    `
                                        : `
                                        <!-- Non-YouTube video download -->
                                        <div class="option-row">
                                            <div class="option-group">
                                                <label>Video Format</label>
                                                <select id="videoFormat">
                                                    <option value="mp4" selected>MP4 (Best Quality)</option>
                                                    <option value="mkv">MKV (High Quality)</option>
                                                    <option value="webm">WebM (Small Size)</option>
                                                </select>
                                            </div>
                                        </div>
                                    `
                                    }
                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>
                                                <input type="checkbox" id="embedSubs" checked>
                                                Embed Subtitles (if available)
                                            </label>
                                            <label>
                                                <input type="checkbox" id="addMetadata" checked>
                                                Add Video Metadata
                                            </label>
                                        </div>
                                    </div>
                                `
                                    : `
                                    <!-- Audio Options (Music mode) -->
                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>Audio Format</label>
                                            <select id="audioFormat">
                                                <option value="mp3" selected>MP3 (Universal)</option>
                                                <option value="m4a">M4A (Apple)</option>
                                                <option value="opus">Opus (High Quality)</option>
                                                <option value="vorbis">Vorbis (OGG)</option>
                                                <option value="wav">WAV (Lossless)</option>
                                                <option value="flac">FLAC (Lossless)</option>
                                            </select>
                                        </div>
                                        <div class="option-group">
                                            <label>Audio Quality</label>
                                            <select id="audioQuality">
                                                <option value="0" selected>Best (320kbps)</option>
                                                <option value="2">High (256kbps)</option>
                                                <option value="5">Medium (192kbps)</option>
                                                <option value="9">Low (128kbps)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>
                                                <input type="checkbox" id="embedThumbnail" checked>
                                                Embed Thumbnail/Album Art
                                            </label>
                                            <label>
                                                <input type="checkbox" id="addMetadata" checked>
                                                Add Song Metadata (Artist, Title, etc.)
                                            </label>
                                        </div>
                                    </div>
                                `
                                }
                            </div>

                            <!-- Advanced Options Tab -->
                            <div id="advancedOptionsTab" class="options-tab-content">
                                ${
                                  info.is_playlist
                                    ? `
                                    <!-- Playlist Options (only show when playlist detected) -->
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                        <h4 style="margin: 0 0 10px 0; color: white; display: flex; align-items: center; gap: 8px;">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15V6"></path>
                                                <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"></path>
                                                <path d="M12 12H3"></path>
                                                <path d="M16 6H3"></path>
                                                <path d="M12 18H3"></path>
                                            </svg>
                                            Playlist Detected!
                                        </h4>
                                        <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 0.9em;">
                                            This URL contains a playlist. Choose how you want to download it.
                                        </p>
                                    </div>
                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>Playlist Handling</label>
                                            <select id="playlistOption">
                                                <option value="no-playlist" selected>Single ${
                                                  urlMode === "video"
                                                    ? "Video"
                                                    : "Song"
                                                } Only</option>
                                                <option value="yes-playlist">Entire Playlist</option>
                                                <option value="playlist-items">Specific Items (1,2,5-10)</option>
                                            </select>
                                        </div>
                                        <div class="option-group" id="playlistItemsGroup" style="display: none;">
                                            <label>Playlist Items</label>
                                            <input type="text" id="playlistItems" placeholder="e.g., 1,2,5-10">
                                        </div>
                                    </div>
                                `
                                    : ""
                                }

                                ${
                                  urlMode === "video"
                                    ? `
                                    <!-- Video-specific Advanced Options -->
                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>Subtitles/Captions</label>
                                            <select id="subtitleOption">
                                                <option value="none" selected>No Subtitles</option>
                                                <option value="auto">Auto-generated (English)</option>
                                                <option value="all">All Available Languages</option>
                                            </select>
                                        </div>
                                        <div class="option-group">
                                            <label>Speed Limit</label>
                                            <input type="text" id="speedLimit" placeholder="e.g., 1M, 500K (blank = no limit)">
                                        </div>
                                    </div>

                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>
                                                <input type="checkbox" id="geoBypass">
                                                Geo-bypass (Skip region restrictions)
                                            </label>
                                            <label>
                                                <input type="checkbox" id="preferFreeFormats">
                                                Prefer Free Video Formats (VP9/AV1)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>
                                                <input type="checkbox" id="embedSubs" checked>
                                                Embed Subtitles (for videos)
                                            </label>
                                            <label>
                                                <input type="checkbox" id="addChapters">
                                                Add Video Chapters (if available)
                                            </label>
                                        </div>
                                    </div>
                                `
                                    : `
                                    <!-- Music-specific Advanced Options -->
                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>Speed Limit</label>
                                            <input type="text" id="speedLimit" placeholder="e.g., 1M, 500K (blank = no limit)">
                                        </div>
                                        <div class="option-group">
                                            <label>
                                                <input type="checkbox" id="geoBypass">
                                                Geo-bypass (Skip region restrictions)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="option-row">
                                        <div class="option-group">
                                            <label>
                                                <input type="checkbox" id="preferFreeFormats">
                                                Prefer Free Audio Formats (Opus/Vorbis)
                                            </label>
                                            <label>
                                                <input type="checkbox" id="addMetadata" checked>
                                                Add Song Metadata (Artist, Title, etc.)
                                            </label>
                                        </div>
                                    </div>
                                `
                                }

                                <div class="option-group">
                                    <label>Custom yt-dlp Arguments</label>
                                    <input type="text" id="customArgs" placeholder="e.g., --retries 10 --fragment-retries 10">
                                    <small style="color: var(--text-tertiary); font-size: 0.85em; margin-top: 5px; display: block;">
                                        âš ï¸ Security: Only whitelisted arguments accepted
                                    </small>
                                </div>

                                <div class="option-group">
                                    <label>Max File Size</label>
                                    <input type="text" id="maxFileSize" placeholder="e.g., 100M, 1G (blank = no limit)">
                                    <small style="color: var(--text-tertiary); font-size: 0.85em; margin-top: 5px; display: block;">
                                        Skip files larger than this size
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="download-btn" style="width: 100%; padding: 15px; font-size: 1.2em; font-weight: bold;" 
                            onclick="downloadSong('${
                              processedInfo.url
                            }', 'Downloaded_File', this, true)">
                        Download Now
                    </button>
                    
                    <!-- JioSaavn Suggestions Container (moved below download options) -->
                    ${
                      previewData &&
                      previewData.source === "JioSaavn" &&
                      previewData.pid
                        ? `
                        <div id="jiosaavn-suggestions-container" style="margin: 25px 0;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <h3 style="font-size: 1.4em; color: var(--info-color); margin: 0;">Recommended Tracks</h3>
                                <div class="loading-spinner" style="width: 20px; height: 20px; border: 2px solid var(--border-color); border-top: 2px solid var(--info-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            </div>
                            <p style="color: var(--text-secondary); font-style: italic;">Loading recommendations...</p>
                        </div>
                    `
                        : ""
                    }
                    
                    <!-- SoundCloud Recommendations Container (moved below download options) -->
                    ${
                      previewData &&
                      previewData.source === "SoundCloud" &&
                      previewData.soundcloud_recommendations
                        ? `
                        <div style="margin: 25px 0;">
                            <h3 style="font-size: 1.4em; margin-bottom: 15px; color: var(--info-color); border-bottom: 2px solid var(--info-color); padding-bottom: 8px;">
                                Recommended Tracks (${
                                  previewData.soundcloud_recommendations.length
                                })
                            </h3>
                            <div class="recommended-tracks-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                ${previewData.soundcloud_recommendations
                                  .map((track) => {
                                    const hasValidThumbnail =
                                      track.thumbnail &&
                                      track.thumbnail.trim() !== "" &&
                                      track.thumbnail !== "null";
                                    const trackThumbnail = hasValidThumbnail
                                      ? track.thumbnail
                                      : null;

                                    return `
                                        <div class="recommended-track-card" style="background: var(--bg-card); border-radius: 10px; padding: 15px; border: 1px solid var(--border-color);">
                                            <div style="display: flex; gap: 12px;">
                                                <div style="flex-shrink: 0;">
                                                    ${
                                                      trackThumbnail
                                                        ? `<img src="${trackThumbnail}" alt="${track.title}" loading="lazy" style="width: 60px; height: 60px; border-radius: 6px; object-fit: cover;" />`
                                                        : '<div style="width: 60px; height: 60px; border-radius: 6px; background: #2a2a2a; display: flex; align-items: center; justify-content: center; color: #777; font-size: 24px;">â™ª</div>'
                                                    }
                                                </div>
                                                <div style="flex: 1; min-width: 0;">
                                                    <h5 style="font-size: 1em; margin-bottom: 4px; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${
                                                      track.title
                                                    }</h5>
                                                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 6px;">${
                                                      track.artist
                                                    }</p>
                                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-bottom: 8px;">
                                                        ${track.duration} â€¢ ${
                                      track.plays
                                        ? track.plays.toLocaleString()
                                        : "0"
                                    } plays
                                                    </div>
                                                    <div style="display: flex; gap: 6px;">
                                                        <button class="download-btn" style="flex: 1; padding: 6px 10px; font-size: 0.85em;" onclick="downloadSong('${
                                                          track.url
                                                        }', '${track.title.replace(
                                      /'/g,
                                      "\\'"
                                    )}', this, true)">
                                                            Download
                                                        </button>
                                                        <button class="advanced-btn" style="padding: 6px 8px; font-size: 0.85em;" onclick="openAdvancedDownload('${
                                                          track.url
                                                        }', '${track.title.replace(
                                      /'/g,
                                      "\\'"
                                    )}', this)" title="Advanced Options">
                                                            âš™
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                  })
                                  .join("")}
                            </div>
                        </div>
                    `
                        : ""
                    }
                </div>
            `;

        // Asynchronously load JioSaavn suggestions if PID is available
        if (
          previewData &&
          previewData.source === "JioSaavn" &&
          previewData.pid
        ) {
          setTimeout(() => {
            loadJioSaavnSuggestions(
              previewData.pid,
              section,
              previewData.language
            );
          }, 100); // Small delay to ensure DOM is ready
        }

        return section;
      }

      function createSourceSection(title, songs, sourceId) {
        const section = document.createElement("div");
        section.className = "source-section";
        section.id = sourceId;

        const header = document.createElement("div");
        header.className = "source-header";
        header.innerHTML = `
                <h2>${title}</h2>
                <span class="count">${songs.length} results</span>
            `;

        const grid = document.createElement("div");
        grid.className = "songs-grid";

        songs.forEach((song, index) => {
          const card = createSongCard(song, sourceId, index);
          grid.appendChild(card);
        });

        section.appendChild(header);
        section.appendChild(grid);

        // Initialize lazy loading for newly added images
        setTimeout(() => {
          initLazyLoadingForNewImages();
        }, 0);

        return section;
      }

      function createSongCard(song, sourceId, index) {
        const card = document.createElement("div");
        card.className = "song-card";
        card.dataset.songId = `${sourceId}-${index}`;

        // Use proxy for images to avoid CORS - handled by createLazyImage now
        const thumbnailUrl = song.thumbnail
          ? song.thumbnail
          : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23333"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23666">No Image</text></svg>';

        // Build metadata string based on source
        let metadataHTML = "";

        if (sourceId === "soundcloud") {
          const parts = [];
          if (song.duration) parts.push(`â±ï¸ ${song.duration}`);
          if (song.plays) parts.push(`â–¶ï¸ ${song.plays.toLocaleString()}`);
          if (song.likes) parts.push(`â¤ï¸ ${song.likes.toLocaleString()}`);
          if (song.genre)
            parts.push(
              `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 3px;"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>${song.genre}`
            );

          if (parts.length > 0) {
            metadataHTML = `<div class="song-metadata">${parts
              .map((p) => `<span>${p}</span>`)
              .join("")}</div>`;
          }
        } else if (sourceId === "jiosaavn") {
          const parts = [];
          if (song.year) parts.push(`ðŸ“… ${song.year}`);
          if (song.language) parts.push(`ðŸ—£ï¸ ${song.language}`);
          if (song.subtitle) parts.push(`ðŸ“€ ${song.subtitle}`);

          if (parts.length > 0) {
            metadataHTML = `<div class="song-metadata">${parts
              .map((p) => `<span>${p}</span>`)
              .join("")}</div>`;
          }
        }

        // Better artist display for JioSaavn
        let artistDisplay = song.artist || "Unknown Artist";
        if (sourceId === "jiosaavn" && song.subtitle && !song.artist) {
          // Extract artist from subtitle if available
          artistDisplay = song.subtitle.split(" - ")[0] || "Unknown Artist";
        }

        const buttonId = `download-btn-${sourceId}-${index}`;
        const advancedBtnId = `advanced-btn-${sourceId}-${index}`;

        // Determine thumbnail class based on search type
        const thumbnailClass =
          searchType === "video"
            ? "song-thumbnail video-thumbnail"
            : "song-thumbnail";

        card.innerHTML = `
                ${createLazyImage(thumbnailUrl, song.title, thumbnailClass)}
                <div class="song-title">${song.title}</div>
                <div class="song-artist">${artistDisplay}</div>
                ${metadataHTML}
                <div class="song-actions" style="display: flex; gap: 5px;">
                    <button id="${buttonId}" class="download-btn" style="flex: 1;" onclick="downloadSong('${
          song.url
        }', '${song.title.replace(/'/g, "\\'")}', this)">
                        Download
                    </button>
                    <button 
                        id="${advancedBtnId}" 
                        class="advanced-btn" 
                        data-song-url="${song.url}" 
                        data-song-title="${song.title}"
                        style="padding: 10px 15px; background: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; position: relative; z-index: 999;" 
                        title="Advanced Options">
                        âš™
                    </button>
                </div>
            `;

        return card;
      }

      async function downloadSong(url, title, button, useAdvanced = false) {
        // Check if download should be queued
        if (activeDownloads >= MAX_CONCURRENT_DOWNLOADS) {
          queueDownload(url, title, button, useAdvanced);
          return;
        }

        // Start download immediately
        activeDownloads++;
        startDownload(url, title, useAdvanced, button);
      }

      // Open advanced download options for song search results
      function openAdvancedDownload(url, title, button) {
        // Set search input to the URL
        const searchInput = document.getElementById("searchInput");
        searchInput.value = url;

        // Preserve the current search type by explicitly calling selectSearchType
        // This ensures the search type remains as "video" if user was searching videos
        selectSearchType(searchType);

        // Perform the search which will show advanced options
        performSearch();
      }

      async function startDownload(
        url,
        title,
        useAdvanced = false,
        button = null
      ) {
        console.log(`\n${"=".repeat(70)}`);
        console.log(`ðŸŽµ Starting download`);
        console.log(`   Title: ${title}`);
        console.log(`   URL: ${url}`);
        console.log(`   Use Advanced: ${useAdvanced}`);
        console.log(`${"=".repeat(70)}\n`);

        // Find button if not provided
        if (!button) {
          // Try to find the button for this song (for resumed downloads)
          const buttons = document.querySelectorAll(".download-btn");
          for (let btn of buttons) {
            if (btn.onclick && btn.onclick.toString().includes(url)) {
              button = btn;
              break;
            }
          }
        }

        if (button) {
          button.disabled = true;
          button.className = "download-btn downloading";
          button.innerHTML = "â³ Starting...";
        }

        try {
          // Prepare request body
          const requestBody = { url, title };

          // Add advanced options if they should be used
          if (useAdvanced) {
            // Determine if this is video or audio based on searchType
            const isVideoMode = searchType === "video";

            // Build custom args from advanced options
            let customArgs = document.getElementById("customArgs")?.value || "";

            // Add playlist options
            const playlistOption =
              document.getElementById("playlistOption")?.value;
            if (playlistOption === "no-playlist") {
              customArgs += " --no-playlist";
            } else if (playlistOption === "playlist-items") {
              const items = document.getElementById("playlistItems")?.value;
              if (items) {
                customArgs += ` --playlist-items ${items}`;
              }
            }
            // If 'yes-playlist', download entire playlist (default yt-dlp behavior)

            // Add subtitle options
            const subtitleOption =
              document.getElementById("subtitleOption")?.value;
            if (subtitleOption === "auto") {
              customArgs += " --write-auto-subs --sub-langs en";
            } else if (subtitleOption === "all") {
              customArgs += " --write-auto-subs --sub-langs all";
            }

            // Add speed limit
            const speedLimit = document
              .getElementById("speedLimit")
              ?.value?.trim();
            if (speedLimit) {
              customArgs += ` --limit-rate ${speedLimit}`;
            }

            // Add max file size
            const maxFileSize = document
              .getElementById("maxFileSize")
              ?.value?.trim();
            if (maxFileSize) {
              customArgs += ` --max-filesize ${maxFileSize}`;
            }

            // Add boolean flags
            if (document.getElementById("geoBypass")?.checked) {
              customArgs += " --geo-bypass";
            }
            if (document.getElementById("preferFreeFormats")?.checked) {
              customArgs += " --prefer-free-formats";
            }
            if (document.getElementById("addChapters")?.checked) {
              customArgs += " --add-chapters";
            }

            requestBody.advancedOptions = {
              keepVideo: isVideoMode,
              embedSubtitles:
                document.getElementById("embedSubs")?.checked !== false,
              addMetadata:
                document.getElementById("addMetadata")?.checked !== false,
              customArgs: customArgs.trim(),
            };

            // Add video-specific options
            if (isVideoMode) {
              const videoQuality =
                document.getElementById("videoQuality")?.value;
              const videoFPS = document.getElementById("videoFPS")?.value;
              const videoFormat =
                document.getElementById("videoFormat")?.value || "mkv";

              requestBody.advancedOptions.videoQuality = videoQuality;
              requestBody.advancedOptions.videoFPS = videoFPS;
              requestBody.advancedOptions.videoFormat = videoFormat;
            } else {
              // Audio-specific options
              requestBody.advancedOptions.audioFormat =
                document.getElementById("audioFormat")?.value || "mp3";
              requestBody.advancedOptions.audioQuality =
                document.getElementById("audioQuality")?.value || "0";
              requestBody.advancedOptions.embedThumbnail =
                document.getElementById("embedThumbnail")?.checked !== false;
            }
          }

          console.log(`ðŸ“¤ Sending download request:`, requestBody);

          const response = await fetch(`${getApiBaseUrl()}/download`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          console.log(`ðŸ“¡ Download response status: ${response.status}`);

          const data = await response.json();

          console.log(`ðŸ“¦ Download response data:`, data);

          // Check for API errors
          if (!response.ok || data.error) {
            console.error(`âŒ Download request error:`, data);
            throw new Error(data.error || "Download request failed");
          }

          const downloadId = data.download_id;

          console.log(`âœ… Download initiated with ID: ${downloadId}`);

          // Poll download status with timeout tracking
          if (button) {
            pollDownloadStatus(downloadId, button, title, 0); // Start with attempt 0
          }
        } catch (error) {
          console.error("âŒ Download start error:", error);
          if (button) {
            button.className = "download-btn";
            button.innerHTML = "âŒ Failed";
            button.disabled = false;
          }
          showNotification(`âŒ Download failed: ${error.message}`, "error");

          // Download finished (failed), process next in queue
          activeDownloads--;
          processQueue();
        }
      }

      async function pollDownloadStatus(
        downloadId,
        button,
        title,
        attemptCount = 0
      ) {
        const MAX_ATTEMPTS = 120; // Maximum 2 minutes of polling with exponential backoff

        // Safety check: stop polling after too many attempts
        if (attemptCount >= MAX_ATTEMPTS) {
          console.error(
            `â±ï¸ Polling timeout for ${downloadId} after ${attemptCount} attempts`
          );
          if (button) {
            button.className = "download-btn";
            button.innerHTML = "â±ï¸ Timeout";
            button.disabled = false;
          }

          showNotification(`â±ï¸ Download timeout: ${title}`, "error");

          // Download timed out, process next in queue
          activeDownloads--;
          processQueue();
          return;
        }

        try {
          const response = await fetch(
            `${getApiBaseUrl()}/download_status/${downloadId}`
          );

          // Check if response is ok
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          // Debug logging
          console.log(`Download Status [${downloadId}]:`, data);

          // Update local download data
          allDownloads[downloadId] = {
            id: downloadId,
            title: data.title || title,
            url: url,
            status: data.status,
            progress: data.progress || 0,
            error: data.error || null,
            download_url: data.download_url || null,
          };

          saveDownloadsToStorage();
          updateDownloadManager();
          updateDownloadBadge();

          if (data.status === "complete") {
            if (button) {
              button.className = "download-btn complete";
              button.innerHTML =
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; margin-right: 5px;"><polyline points="20 6 9 17 4 12"></polyline></svg>Downloaded';
            }

            // Automatically trigger browser download
            if (data.download_url) {
              const link = document.createElement("a");
              // Ensure full URL for download
              link.href = data.download_url.startsWith("http")
                ? data.download_url
                : `${getApiBaseUrl()}${data.download_url}`;
              link.download = data.file || title || "download";
              link.style.display = "none";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              console.log(`âœ… Auto-downloaded: ${title}`);
              showNotification(`Downloaded: ${title}`, "success");
            }

            // Download finished, process next in queue
            activeDownloads--;
            processQueue();
          } else if (data.status === "error") {
            if (button) {
              button.className = "download-btn";
              button.innerHTML = "âŒ Failed";
              button.disabled = false;
            }
            showNotification(
              `âŒ Download failed: ${data.error || "Unknown error"}`,
              "error"
            );

            // Download finished (failed), process next in queue
            activeDownloads--;
            processQueue();
          } else if (data.status === "cancelled") {
            if (button) {
              button.className = "download-btn";
              button.innerHTML = "ðŸš« Cancelled";
              button.disabled = false;
            }

            // Download cancelled, process next in queue
            activeDownloads--;
            processQueue();
          } else if (data.status === "downloading") {
            // Show progress
            const progress = data.progress || 0;
            const speed = data.speed || "N/A";
            const eta = data.eta || "N/A";

            console.log(
              `â³ Downloading [${downloadId}]: ${Math.round(
                progress
              )}% - ${speed} - ETA ${eta}`
            );

            if (button) {
              button.className = "download-btn downloading";
              button.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <div>â³ ${Math.round(progress)}%</div>
                                <div style="font-size: 0.75em; opacity: 0.8;">${speed} â€¢ ETA ${eta}</div>
                            </div>
                        `;
            }

            // Use exponential backoff: start at 1s, max 5s
            const pollInterval = Math.min(1000 + attemptCount * 100, 5000);
            console.log(
              `ðŸ”„ Polling again in ${pollInterval}ms (attempt ${
                attemptCount + 1
              })`
            );

            // Keep polling with incremented attempt count
            setTimeout(
              () =>
                pollDownloadStatus(downloadId, button, title, attemptCount + 1),
              pollInterval
            );
          } else {
            // Keep polling for other statuses (preparing, queued, etc.) with incremented attempt count
            console.log(
              `ðŸ”„ Status '${data.status}' - polling again (attempt ${
                attemptCount + 1
              })`
            );

            // Use exponential backoff for unknown states too
            const pollInterval = Math.min(1000 + attemptCount * 100, 5000);

            setTimeout(
              () =>
                pollDownloadStatus(downloadId, button, title, attemptCount + 1),
              pollInterval
            );
          }
        } catch (error) {
          // Check if it's a network error or timeout
          const errorMessage = error.message || "Unknown error";
          console.error(`âŒ Poll status error for ${downloadId}:`, error);
          console.error(
            `   Attempt: ${attemptCount}, URL: ${getApiBaseUrl()}/download_status/${downloadId}`
          );

          if (button) {
            button.className = "download-btn";
            button.innerHTML = "âŒ Error";
            button.disabled = false;
          }

          showNotification(`âŒ Status check failed: ${errorMessage}`, "error");

          // Download failed, process next in queue
          activeDownloads--;
          processQueue();
        }
      }

      // Show notification
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");

        // Use semantic colors
        let bgColor, textColor, borderColor;

        if (type === "success") {
          bgColor = "var(--success-color)";
          textColor = "white";
          borderColor = "var(--success-color)";
        } else if (type === "error") {
          bgColor = "var(--error-color)";
          textColor = "white";
          borderColor = "var(--error-color)";
        } else {
          bgColor = "var(--accent-color)";
          textColor = "white";
          borderColor = "var(--accent-color)";
        }

        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${bgColor};
                color: ${textColor};
                border: 1px solid ${borderColor};
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
                font-size: 14px;
            `;
        notification.innerHTML = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease-out";
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      // Global event delegation for advanced buttons
      document.addEventListener("click", function (e) {
        if (e.target && e.target.classList.contains("advanced-btn")) {
          e.preventDefault();
          e.stopPropagation();

          const url = e.target.getAttribute("data-song-url");
          const title = e.target.getAttribute("data-song-title");

          openAdvancedDownload(url, title, e.target);
        }
      });

      // Lazy Loading Implementation
      let imageObserver;

      function initLazyLoading() {
        // Check if Intersection Observer is supported
        if ("IntersectionObserver" in window) {
          imageObserver = new IntersectionObserver(
            (entries, observer) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  const img = entry.target;
                  loadImage(img);
                  observer.unobserve(img);
                }
              });
            },
            {
              // Start loading when image is 100px away from viewport
              rootMargin: "100px",
              threshold: 0.01,
            }
          );
        }
      }

      function loadImage(img) {
        const src = img.dataset.src;
        if (!src) return;

        // Add loading class for visual feedback
        img.classList.add("loading");

        // Create a new image to preload
        const imageLoader = new Image();

        imageLoader.onload = () => {
          // Image loaded successfully
          img.src = src;
          img.classList.remove("loading");
          img.classList.add("loaded");

          // Remove data-src to avoid reprocessing
          delete img.dataset.src;
        };

        imageLoader.onerror = () => {
          // Handle image load error - use professional music placeholder
          const musicPlaceholder =
            "data:image/svg+xml;base64," +
            btoa(
              '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><rect width="120" height="120" fill="#2a2a2a"/><circle cx="60" cy="60" r="35" fill="none" stroke="#555" stroke-width="2"/><circle cx="60" cy="60" r="15" fill="none" stroke="#555" stroke-width="1.5"/><circle cx="60" cy="60" r="3" fill="#555"/><path d="M60 25 L75 35 L75 40 L60 30 Z" fill="#666"/><text x="60" y="100" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#777">No Image</text></svg>'
            );
          img.src = img.dataset.fallback || musicPlaceholder;
          img.classList.remove("loading");
          img.classList.add("loaded");
          delete img.dataset.src;
        };

        // Start loading the image
        imageLoader.src = src;
      }

      function observeImage(img) {
        if (imageObserver) {
          imageObserver.observe(img);
        } else {
          // Fallback for browsers without Intersection Observer
          loadImage(img);
        }
      }

      // Function to create lazy loading image element
      function createLazyImage(
        src,
        alt = "",
        className = "",
        style = "",
        fallbackSrc = null
      ) {
        // Create a professional music placeholder SVG (single line to avoid btoa issues)
        const musicPlaceholder =
          "data:image/svg+xml;base64," +
          btoa(
            '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><rect width="120" height="120" fill="#2a2a2a"/><circle cx="60" cy="60" r="35" fill="none" stroke="#555" stroke-width="2"/><circle cx="60" cy="60" r="15" fill="none" stroke="#555" stroke-width="1.5"/><circle cx="60" cy="60" r="3" fill="#555"/><path d="M60 25 L75 35 L75 40 L60 30 Z" fill="#666"/><text x="60" y="100" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#777">No Image</text></svg>'
          );

        const fallback = fallbackSrc || musicPlaceholder;

        // Check if src is empty, null, or invalid
        let actualSrc =
          src &&
          src.trim() &&
          src !== "" &&
          src !== "null" &&
          src !== "undefined"
            ? src
            : fallback;

        // Convert HTTP to HTTPS to avoid mixed content issues
        if (
          actualSrc &&
          actualSrc.startsWith("http://") &&
          !actualSrc.includes("localhost")
        ) {
          actualSrc = actualSrc.replace("http://", "https://");
        }

        // Proxy external images through backend to avoid CORS issues in production
        if (
          actualSrc &&
          actualSrc.startsWith("http") &&
          !actualSrc.startsWith("data:")
        ) {
          // Only proxy if not on localhost (production environment)
          const hostname = window.location.hostname;
          if (hostname !== "localhost" && hostname !== "127.0.0.1") {
            let apiBase = getApiBaseUrl();

            // Emergency fallback if apiBase is somehow empty
            if (!apiBase || apiBase === "") {
              apiBase = "https://song-download-9889cf8e8f85.herokuapp.com";
            }

            actualSrc = `${apiBase}/proxy_image?url=${encodeURIComponent(
              actualSrc
            )}`;
          }
        }

        return `<img 
                data-src="${actualSrc}" 
                data-fallback="${fallback}"
                alt="${alt}" 
                class="${className}" 
                style="${style}"
                src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='1' height='1'></svg>"
                onerror="this.src='${fallback}'"
            >`;
      }

      // Initialize lazy loading when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        initLazyLoading();
      });

      // Re-initialize lazy loading for dynamically added images
      function initLazyLoadingForNewImages() {
        const lazyImages = document.querySelectorAll(
          "img[data-src]:not(.loaded):not(.loading)"
        );
        lazyImages.forEach((img) => {
          observeImage(img);
        });
      }
    </script>
  </body>
</html>
